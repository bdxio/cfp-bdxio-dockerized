version: '2'

services:
  traefik:
    image: traefik:1.6.4
    restart: always
    ports:
      - 80:80
      - 443:443
    networks:
      - web
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - $PWD/traefik.toml:/traefik.toml
      - $PWD/acme.json:/acme.json

  es-prod:
    image: elasticsearch
    restart: always
    expose:
      - "9300"
      - "9200"

  es-testing:
    image: elasticsearch
    restart: always
    expose:
      - "9300"
      - "9200"

  redis-prod:
    image: redis:2.8
    restart: always
    expose:
      - "6379"
    volumes:
      - $PWD/dropbox/cfp-backups/prod/redis:/data/
      - $PWD/logs/prod:/var/log/redis/
      - $PWD/redis/redis-config-prod.conf:/etc/redis.conf
    command: redis-server /etc/redis.conf

  redis-testing:
    image: redis:2.8
    restart: always
    expose:
      - "6379"
    volumes:
      - $PWD/dropbox/cfp-backups/testing/redis:/data/
      - $PWD/logs/testing:/var/log/redis/
      - $PWD/redis/redis-config-testing.conf:/etc/redis.conf
    command: redis-server /etc/redis.conf

  cfp-prod:
    build: ./webapp
    restart: always
    networks:
      - web
      - default
    expose:
      - "9000"
    labels:
      - "traefik.docker.network=web"
      - "traefik.enable=true"
      - "traefik.basic.frontend.rule=Host:cfp.bdx.io"
      - "traefik.basic.port=9000"
      - "traefik.basic.protocol=http"
    volumes:
      - $PWD/cfp-src-prod:/app

  cfp-testing:
    build: ./webapp
    restart: always
    networks:
      - web
      - default
    expose:
      - "9000"
    labels:
      - "traefik.docker.network=web"
      - "traefik.enable=true"
      - "traefik.basic.frontend.rule=Host:cfp-testing.bdx.io"
      - "traefik.basic.port=9000"
      - "traefik.basic.protocol=http"
    volumes:
      - $PWD/cfp-src-testing:/app

networks:
  web:
